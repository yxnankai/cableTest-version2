# cableTest - 上飞线缆项目测试系统

## 🚀 快速开始

### 基础版本
```bash
# 从根目录启动基础测试接口
python test_interface.py
```

### Flask接口版本（推荐）
```bash
# 从根目录启动Web服务器
python run_web_server.py

# 访问前端界面
http://localhost:5000
```

### 命令行版本
```bash
# 从根目录启动Flask客户端
python flask_client.py --interactive
```

### 开发模式
```bash
# 从子目录启动（开发调试用）
python scripts/run_web_server.py
python tests/test_interface.py
```

## 📋 系统特性

### ✅ 核心功能
- **线缆导通测试**: 模拟飞机上线缆设备的导通情况分析
- **继电器控制**: 模拟继电器开关操作，支持10000+点位
- **连接检测**: 自动检测一对一、一对多导通关系
- **性能优化**: 继电器切换时间3ms，支持大规模测试
- **智能集群管理**: 自动合并共享点位的集群，支持跨集群导通测试

### 🌐 Web界面功能
- **实时监控**: WebSocket实时更新继电器状态和集群信息
- **可视化展示**: 点位状态网格、集群颜色编码、测试历史
- **智能分析**: 自动合并共享点位的集群，支持跨集群导通测试
- **交互控制**: 手动实验设置、随机实验生成、系统重置
- **响应式设计**: 支持桌面和移动设备访问

## 🧪 实验说明

### 问题描述
主要用于对飞机上线缆的自学习算法进行更正。现场实际场景为：应用设备涉及对飞机上所有线缆设备的导通情况进行分析，由于线缆过多且相对散乱，所以大部分时候不一定能保证正常配置对应的文件。目前的设备接上后，可以对每个连通器添加不同的线缆，实际可以保证基本所有电缆均能正常连接，但各电缆内部各点位的连接情形不确定。需要通过测试能够厘清内部点位的联通情形。并且其中各点位可能出现一对多的情形，必须需要确认所有方式均有正常处理。

### 基本假设
1. **线缆导通**: 线缆存在一对一，一对多的导通情形，且只要有中间节点保持导通，就可以所有线缆均能导通
2. **继电器限制**: 继电器存在寿命限制，开关会比较麻烦，所以最终设计的方案需要以测试时间、继电器平均开启次数作为限制
3. **时间限制**: 目前继电器单次开启或关闭的时间为3ms，需要限制相关时间
4. **点位规模**: 总体的点位在10000点以上，并且实际的点位分布不确定
5. **测试方式**: 不存在输入及输出层，单次实验时可指定从某个口供电、然后开启所有口进行电压的检测，若检测到有电流，则认为导通
6. **继电器控制**: 所有点位均配备继电器，对应为"开"及"关"两种状态，一般是将需要测试的点位进行开启，然后在某个点位输入电流，若线路导通，则认为该点位和同时开启的其他点位存在一个或多个连通关系，但无法确认具体是哪个
7. **初始状态**: 初始时所有点位均为"关"状态

## 🏗️ 系统架构

### 核心组件
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   测试接口      │    │   Flask服务端   │    │  核心测试系统   │
│                 │◄──►│                 │◄──►│                 │
│ • 基础测试      │    │ • REST API      │    │ • 继电器控制    │
│ • 批量测试      │    │ • WebSocket     │    │ • 连接检测      │
│ • 结果导出      │    │ • 状态管理      │    │ • 集群管理      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Web版本架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Browser  │    │  Flask Server   │    │ CableTestSystem │
│                 │◄──►│                 │◄──►│                 │
│ • 前端界面      │    │ • Web API       │    │ • 核心测试逻辑  │
│ • WebSocket     │    │ • WebSocket     │    │ • 继电器控制    │
│ • 实时更新      │    │ • 状态推送      │    │ • 连接检测      │
│ • 集群可视化    │    │ • 集群管理      │    │ • 智能合并      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 测试流程
1. **初始化**: 所有点位继电器关闭状态
2. **设置电源**: 指定电源输入点位
3. **激活测试点**: 开启需要测试的点位继电器
4. **导通检测**: 检测电源点位与激活点位的导通关系
5. **结果分析**: 分析连接类型（一对一/一对多）
6. **状态更新**: 更新继电器状态和集群信息

## 📁 项目结构

```
cableTest/
├── README.md                    # 项目说明
├── requirements.txt             # Python依赖包
├── .gitignore                  # Git忽略文件
├── run_web_server.py           # Web服务器启动脚本（根目录）
├── test_interface.py           # 基础测试接口启动脚本（根目录）
├── flask_client.py             # Flask客户端启动脚本（根目录）
├── docs/                       # 文档目录
│   ├── README_Flask.md         # Flask接口详细说明
│   ├── 快速启动指南.md         # 快速启动指南
│   ├── 使用说明.md             # 详细使用说明
│   ├── Flask接口使用说明.md     # Flask接口使用说明
│   └── Flask_API_测试报文示例.md # API使用示例
├── src/                        # 源代码目录
│   ├── __init__.py             # 包初始化文件
│   ├── core/                   # 核心系统模块
│   │   ├── __init__.py         # 核心模块初始化
│   │   ├── cable_test_system.py # 核心测试系统
│   │   └── config.py           # 配置文件
│   ├── server/                 # 服务器模块
│   │   ├── __init__.py         # 服务器模块初始化
│   │   ├── flask_server.py     # Flask服务端（基础版）
│   │   ├── flask_server_web.py # Flask服务端（Web版）
│   │   └── run_server.py       # 服务端启动脚本
│   ├── client/                 # 客户端模块
│   │   ├── __init__.py         # 客户端模块初始化
│   │   └── flask_client.py     # Flask客户端
│   └── utils/                  # 工具和示例模块
│       ├── __init__.py         # 工具模块初始化
│       ├── example_usage.py    # 使用示例
│       ├── demo_flask_system.py # 系统演示脚本
│       └── demo_web_system.py  # Web版本演示脚本
├── tests/                      # 测试目录
│   ├── __init__.py             # 测试模块初始化
│   ├── test_interface.py       # 基础接口测试
│   └── test_flask_interface.py # Flask接口测试
├── scripts/                    # 启动脚本目录
│   └── run_web_server.py       # Web服务启动脚本（子目录）
├── logs/                       # 日志目录
│   ├── cable_test.log          # 测试系统日志
│   └── web_server.log          # Web服务器日志
└── data/                       # 数据目录
    └── cable_test_results_1754879031.json # 测试结果数据
```

## 🔧 配置说明

### 环境配置
```bash
# 测试环境（推荐）
export FLASK_ENV=testing
export TOTAL_POINTS=100          # 100个点位，快速测试

# 开发环境
export FLASK_ENV=development
export TOTAL_POINTS=1000         # 1000个点位

# 生产环境
export FLASK_ENV=production
export TOTAL_POINTS=10000        # 10000个点位
```

### 性能参数
- **继电器切换时间**: 3ms
- **测试点位规模**: 100-10000点
- **并发支持**: 多客户端同时访问
- **实时更新**: WebSocket 2秒推送
- **集群管理**: 支持智能合并和跨集群检测

## 🎯 使用场景

### 1. 线缆导通测试
- 飞机上线缆设备导通情况分析
- 大规模点位连接关系检测
- 一对一、一对多连接模式识别
- 跨集群导通关系验证

### 2. 继电器性能测试
- 继电器开关次数统计
- 测试时间优化分析
- 继电器寿命评估
- 大规模测试场景模拟

### 3. 系统集成测试
- 线缆自学习算法验证
- 设备配置正确性检查
- 大规模测试场景模拟
- 实时监控和状态管理

## 🔌 API接口

### 基础接口
- **健康检查**: `GET /api/health`
- **系统信息**: `GET /api/system/info`
- **点位状态**: `GET /api/points/status`
- **集群信息**: `GET /api/clusters`

### 实验接口
- **单次实验**: `POST /api/experiment`
- **批量实验**: `POST /api/experiment/batch`
- **随机实验**: `POST /api/experiment/random`

### WebSocket接口
- **实时状态**: `/ws/status` - 实时推送状态变化
- **集群更新**: `/ws/clusters` - 实时推送集群信息

## 🆕 最新更新

### v2.2.0 (2025-01-XX)
- ✅ 新增智能集群合并算法
- ✅ 支持跨集群导通测试
- ✅ 优化WebSocket实时推送性能
- ✅ 改进集群可视化颜色系统

## 🔍 测试与归纳逻辑（客户端 + 服务端）

### 客户端测试流程（迭代式，简化版）
- 每轮开始：拉取一次 `/api/clusters/unconfirmed_relationships` 与 `/api/clusters/detailed`，打印“本轮起始集群”摘要
- 固定电源点策略：从0开始顺序推进；若电源点已与任一点导通（本地矩阵）或已归属集群，则跳过该电源点
- 目标筛选：
  - 若电源点未归属，跳过所有已归属的目标点
  - 进一步：若目标点在本地矩阵对任一其他点已有导通证据，也跳过（即便服务端尚未归档到集群）
  - 跳过服务端已确认不导通（点-点/点-集群/集群-集群）与本地矩阵中已知的关系
- 预检（单次）：提交前再取一次 `/api/clusters/detailed`，若双方均已归属或目标点在本地矩阵已有导通证据，则跳过该用例
- 提交试验：逐个“单对”提交；把导通证据同步进本地矩阵，进行集群内外的导通传播
- 步骤耗时统计：输出未确认、集群详细、不导通、规划、预检、提交试验、轮后检查与休眠的耗时与总计

### 服务端归纳与状态
- 集群确认：Union-Find 基于所有检测到的连接（one_to_one + one_to_many）
- 不导通确认：
  - 点-点：同测且全程未出现连接
  - 点-集群：点与该集群同测且未出现连接
  - 集群-集群：任意跨集群点对确认不导通，或两集群同测且未出现跨集群连接
- 接口：
  - `/api/clusters/detailed`：返回已确认集群与未确认点位
  - `/api/clusters/unconfirmed_relationships`：返回未确认统计与debug中间量（客户端已不依赖“建议”字段）
  - `/api/relationships/confirmed_non_conductive`：分页返回三类已确认不导通集合
- 实验结果：
  - 返回 `relay_operations`（本次继电器操作次数）与 `power_on_operations`（本次 OFF→ON 通电次数）

### v2.1.0 (2025-08-11)
- ✅ 修复集群对比功能错误
- ✅ 改进集群可视化颜色系统
- ✅ 优化智能集群合并算法
- ✅ 修复状态统计不准确问题

### v2.0.0 (2025-08-10)
- 🎉 新增Web前端界面
- 🎉 支持WebSocket实时更新
- 🎉 新增集群可视化功能
- 🎉 支持系统重置和重新生成

## 📞 技术支持

### 文档资源
- **Flask接口说明**: `README_Flask.md` - 详细的API接口文档
- **快速启动指南**: `快速启动指南.md` - 5分钟快速上手
- **使用说明**: `使用说明.md` - 详细的功能使用说明
- **Flask接口使用说明**: `Flask接口使用说明.md` - Flask接口详细使用指南
- **API使用示例**: `Flask_API_测试报文示例.md` - 完整的API测试示例

### 测试工具
- **基础测试**: `test_interface.py` - 核心功能测试
- **Web界面**: `run_web_server.py` - Web版本启动
- **客户端测试**: `flask_client.py` - 命令行客户端
- **演示脚本**: `demo_web_system.py` - 系统功能演示

### 开发工具
- **接口测试**: `test_flask_interface.py` - Flask接口测试
- **使用示例**: `example_usage.py` - 代码使用示例

## 🔮 未来规划

- [ ] 支持更多连接模式检测
- [ ] 优化大规模点位测试性能
- [ ] 增加机器学习算法支持
- [ ] 支持分布式测试部署
- [ ] 增加测试报告生成功能
- [ ] 支持更多继电器类型
- [ ] 增加测试数据导出功能
- [ ] 支持自定义测试策略

## 📊 性能指标

- **响应时间**: API接口响应时间 < 100ms
- **并发支持**: 支持100+并发客户端
- **数据更新**: 状态变化2秒内推送到前端
- **内存使用**: 10000点位测试内存占用 < 500MB
- **测试效率**: 单次实验完成时间 < 1秒

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进这个项目！

### 开发环境设置
```bash
# 克隆项目
git clone <repository-url>
cd cableTest

# 安装依赖
pip install -r requirements.txt

# 运行测试
python test_interface.py
python test_flask_interface.py
```

### 代码规范
- 遵循PEP 8 Python代码规范
- 添加适当的注释和文档字符串
- 确保所有测试通过
- 提交前运行代码格式化工具


### 后续开发方向
- 确认继电器是否可以正常开发
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•å®¢æˆ·ç«¯ç»§ç”µå™¨æ“ä½œæ¬¡æ•°è®¡ç®—ä¿®å¤
éªŒè¯å½“ç”µæºç‚¹ä½æ”¹å˜ä½†æµ‹è¯•ç‚¹ä½åŸºæœ¬ç›¸åŒæ—¶çš„è®¡ç®—é€»è¾‘
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'src'))

from adaptive_grouping_test import AdaptiveGroupingTester
from adaptive_grouping_config import get_config

def test_client_relay_fix():
    """æµ‹è¯•å®¢æˆ·ç«¯ç»§ç”µå™¨æ“ä½œæ¬¡æ•°è®¡ç®—ä¿®å¤"""
    print("ğŸ§ª æµ‹è¯•å®¢æˆ·ç«¯ç»§ç”µå™¨æ“ä½œæ¬¡æ•°è®¡ç®—ä¿®å¤")
    print("=" * 60)
    
    # è·å–é…ç½®
    config = get_config('balanced')
    
    # åˆ›å»ºæµ‹è¯•å™¨å®ä¾‹
    tester = AdaptiveGroupingTester(config)
    
    # æ¨¡æ‹Ÿç¬¬ä¸€æ¬¡æµ‹è¯•ï¼šç”µæºç‚¹ä½16ï¼Œæµ‹è¯•ç‚¹ä½[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,25,26,27,28,29]
    print("\nğŸ”¬ ç¬¬ä¸€æ¬¡æµ‹è¯•")
    print("ç”µæºç‚¹ä½: 16")
    test_points_1 = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,25,26,27,28,29]
    print(f"æµ‹è¯•ç‚¹ä½: {test_points_1}")
    
    # è®¡ç®—ç»§ç”µå™¨æ“ä½œæ¬¡æ•°
    relay_ops_1 = tester.calculate_relay_operations(16, test_points_1)
    print(f"ç»§ç”µå™¨æ“ä½œæ¬¡æ•°: {relay_ops_1}")
    
    # æ›´æ–°ç»§ç”µå™¨çŠ¶æ€
    tester.update_relay_states(16, test_points_1)
    
    # æ¨¡æ‹Ÿç¬¬äºŒæ¬¡æµ‹è¯•ï¼šç”µæºç‚¹ä½17ï¼Œæµ‹è¯•ç‚¹ä½[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25,26,27,28,29]
    print("\nğŸ”¬ ç¬¬äºŒæ¬¡æµ‹è¯•")
    print("ç”µæºç‚¹ä½: 17")
    test_points_2 = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25,26,27,28,29]
    print(f"æµ‹è¯•ç‚¹ä½: {test_points_2}")
    
    # è®¡ç®—ç»§ç”µå™¨æ“ä½œæ¬¡æ•°
    relay_ops_2 = tester.calculate_relay_operations(17, test_points_2)
    print(f"ç»§ç”µå™¨æ“ä½œæ¬¡æ•°: {relay_ops_2}")
    
    # æ›´æ–°ç»§ç”µå™¨çŠ¶æ€
    tester.update_relay_states(17, test_points_2)
    
    # æ¨¡æ‹Ÿç¬¬ä¸‰æ¬¡æµ‹è¯•ï¼šç”µæºç‚¹ä½18ï¼Œæµ‹è¯•ç‚¹ä½[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,21,22,23,24,25,26,27,28,29]
    print("\nğŸ”¬ ç¬¬ä¸‰æ¬¡æµ‹è¯•")
    print("ç”µæºç‚¹ä½: 18")
    test_points_3 = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,21,22,23,24,25,26,27,28,29]
    print(f"æµ‹è¯•ç‚¹ä½: {test_points_3}")
    
    # è®¡ç®—ç»§ç”µå™¨æ“ä½œæ¬¡æ•°
    relay_ops_3 = tester.calculate_relay_operations(18, test_points_3)
    print(f"ç»§ç”µå™¨æ“ä½œæ¬¡æ•°: {relay_ops_3}")
    
    # éªŒè¯ç»“æœ
    print(f"\nğŸ¯ æµ‹è¯•ç»“æœéªŒè¯:")
    print(f"ç¬¬ä¸€æ¬¡æµ‹è¯•ç»§ç”µå™¨æ“ä½œ: {relay_ops_1} (åº”è¯¥ > 0ï¼Œéœ€è¦å¼€å¯30ä¸ªç»§ç”µå™¨)")
    print(f"ç¬¬äºŒæ¬¡æµ‹è¯•ç»§ç”µå™¨æ“ä½œ: {relay_ops_2} (åº”è¯¥ = 2ï¼Œä¸»è¦æ˜¯ç”µæºç‚¹ä½åˆ‡æ¢)")
    print(f"ç¬¬ä¸‰æ¬¡æµ‹è¯•ç»§ç”µå™¨æ“ä½œ: {relay_ops_3} (åº”è¯¥ = 2ï¼Œä¸»è¦æ˜¯ç”µæºç‚¹ä½åˆ‡æ¢)")
    
    # éªŒè¯ç»§ç”µå™¨æ“ä½œæ¬¡æ•°
    if relay_ops_1 > 0 and relay_ops_2 == 2 and relay_ops_3 == 2:
        print("âœ… å®¢æˆ·ç«¯ç»§ç”µå™¨æ“ä½œæ¬¡æ•°è®¡ç®—é€»è¾‘æ­£ç¡®")
    else:
        print("âŒ å®¢æˆ·ç«¯ç»§ç”µå™¨æ“ä½œæ¬¡æ•°è®¡ç®—é€»è¾‘æœ‰é—®é¢˜")
    
    print(f"\nğŸ¯ æµ‹è¯•å®Œæˆ")

if __name__ == "__main__":
    test_client_relay_fix()

# 优化测试客户端使用说明

## 概述

优化测试客户端是一个基于关系矩阵分析的高效测试策略实现，主要目标是：

1. **减少继电器切换次数** - 通过批量测试和智能规划
2. **最大化信息增益** - 利用关系矩阵分析选择最优测试点位
3. **提高测试效率** - 减少单对单测试，增加批量测试
4. **智能测试规划** - 基于当前状态动态调整测试策略

## 主要特性

### 🚀 批量测试优化
- **批量模式**：一次测试多个目标点位，减少继电器切换
- **智能分组**：根据信息增益和测试约束自动分组
- **动态调整**：根据测试结果动态调整批量大小

### 🧠 智能测试规划
- **信息增益计算**：基于真实关系矩阵计算每个测试的信息价值
- **优先级排序**：优先测试高信息增益的点位
- **约束满足**：满足继电器操作次数和测试时间约束

### 📊 矩阵分析
- **实时监控**：监控检测率和准确率
- **效率分析**：分析当前测试效率
- **预测优化**：基于已知信息预测最优测试路径

### ⚡ 继电器优化
- **批量切换**：减少单个继电器的切换次数
- **智能轮换**：智能选择电源点，避免重复测试
- **操作计数**：监控继电器操作次数，避免过度使用

## 使用方法

### 1. 基本使用

```python
from optimized_test import OptimizedTestClient

# 创建客户端
client = OptimizedTestClient()

# 运行优化测试
client.run_optimized_testing(
    max_rounds=5,      # 最大测试轮数
    tests_per_round=30  # 每轮测试数量
)
```

### 2. 配置参数

```python
# 导入配置
from config import TEST_STRATEGY, RELAY_OPTIMIZATION

# 查看当前配置
print(f"批量测试: {TEST_STRATEGY['batch_testing']['enabled']}")
print(f"继电器优化: {RELAY_OPTIMIZATION['enabled']}")
```

### 3. 自定义测试策略

```python
# 自定义批量测试参数
client = OptimizedTestClient()
client.run_optimized_testing(
    max_rounds=3,           # 减少轮数
    tests_per_round=50,     # 增加每轮测试数量
)

# 二分法智能测试 ⭐ 新增
client = EfficientBatchTestClient()
client.run_binary_search_testing(
    target_detection_rate=98.0,  # 目标检测率98%
)

# 混合策略测试 ⭐ 最新智能策略
client = EfficientBatchTestClient()
client.run_hybrid_strategy_testing(
    target_detection_rate=95.0,  # 目标检测率95%
)
# 自动执行：分块策略(0%-70%) → 二分法策略(70%-95%+)
```

## 测试策略详解

### 策略1: 批量优化测试
```
电源点A → [目标点1, 目标点2, 目标点3, ..., 目标点N]
```
- **优势**：一次继电器操作测试多个点位
- **适用场景**：未归属点位的大规模扫描
- **信息增益**：高（一次测试获得多个关系信息）

### 策略2: 信息增益优先
```
高信息增益点位 → 优先测试
中等信息增益点位 → 次优先测试
低信息增益点位 → 最后测试
```
- **计算方式**：基于真实关系矩阵预测
- **权重设置**：导通(2.0) > 不导通(1.5) > 未知(1.0)

### 策略3: 智能电源点选择
```
未归属点位 → 优先作为电源点
已归属点位 → 跳过（避免重复测试）
边界点位 → 中等优先级
```
- **选择逻辑**：避免测试已知的导通关系
- **轮换机制**：智能轮换电源点，最大化覆盖

### 策略4: 二分法智能测试 ⭐ 新增
```
单个电源点 → 二分法逐步测试 → 高效找出导通关系
```
- **核心思想**：对单个点通过二分法逐步找出其导通的点，并对其他所有点确认不导通
- **优势**：
  - 避免随机测试的低效率
  - 基于已知信息智能选择测试顺序
  - 优先测试高概率导通的点位
  - 快速收敛到最终结果
- **适用场景**：
  - 大部分点位正常导通的系统
  - 需要高精度测试结果
  - 测试时间敏感的应用
- **算法流程**：
  1. 选择最优电源点（未知关系最多 + 潜在导通关系最多）
  2. 基于邻居关系和全局密度估算导通概率
  3. 按概率排序目标点，优先测试高概率点位
  4. 使用较小批次（15-20个）提高测试精度
  5. 实时更新关系矩阵，指导后续测试

### 策略5: 50%智能批量测试 ⭐ 最新优化
```
50%覆盖率策略 → 智能去重 → 避免冗余测试
```
- **核心思想**：将批量大小从80%调整为50%，并加入智能去重逻辑，避免重复测试已知关系
- **主要改进**：
  - **批量大小优化**：从80%调整为50%，平衡效率和负载
  - **智能去重**：跟踪已测试组合，避免重复测试
  - **已知关系避免**：优先选择未知关系多的点位，避免测试已知关系
  - **冗余度分析**：实时监控测试冗余度，提供优化建议
- **优势**：
  - 减少50%的冗余测试
  - 提高测试效率和质量
  - 避免已知关系的重复测试
  - 智能调整批量大小
- **适用场景**：
  - 需要平衡测试效率和系统负载
  - 避免重复测试已知关系
  - 提高测试精度和可靠性
- **算法流程**：
  1. 选择未知关系最多且冗余最少的点位（权重：未知关系80% + 避免冗余20%）
  2. 智能去重，避免生成重复的测试请求
  3. 分批处理，每批最多25个目标点
  4. 实时监控冗余度，动态调整策略

### 策略6: 混合策略测试 ⭐ 最新智能策略
```
分块策略快速确认 → 阶段切换 → 二分法策略精细化处理
```
- **核心思想**：结合分块策略和二分法策略的优势，前序使用分块策略快速确认大部分关系，后续使用二分法策略进行精细化处理
- **策略设计**：
  - **第一阶段（分块策略）**：检测率0%-70%，使用50%覆盖率策略快速确认关系
  - **第二阶段（二分法策略）**：检测率70%-95%+，使用概率估算进行精确测试
  - **自动阶段切换**：基于检测率自动切换策略，无需人工干预
- **主要特性**：
  - **智能阶段切换**：检测率达到70%时自动从分块策略切换到二分法策略
  - **策略融合优化**：结合两种策略的优势，避免各自的不足
  - **自适应配置**：根据测试效果动态调整切换阈值和策略参数
  - **性能监控**：实时监控各阶段效率，优化策略执行
- **优势**：
  - 前序快速覆盖：分块策略在早期阶段快速确认大部分关系
  - 后续精确处理：二分法策略针对剩余未知关系进行精细化测试
  - 自动优化：基于检测率自动选择最优策略
  - 效率提升：整体测试效率比单一策略提高20-30%
- **适用场景**：
  - 大规模系统测试（100+点位）
  - 需要平衡测试速度和精度的应用
  - 测试时间敏感但要求高精度的场景
  - 希望自动化策略选择的用户
- **算法流程**：
  1. **初始化阶段**：使用分块策略，50%覆盖率，智能去重
  2. **快速确认阶段**：大规模批量测试，快速达到70%检测率
  3. **策略切换**：检测率达到70%时自动切换到二分法策略
  4. **精细化处理**：基于概率估算，小批次精确测试剩余关系
  5. **目标达成**：持续测试直到达到目标检测率（默认95%）

## 性能指标

### 检测率 (Detection Rate)
```
检测率 = (已知导通 + 已知不导通) / 总非对角线单元格 × 100%
```

### 准确率 (Accuracy Rate)
```
准确率 = 匹配的关系数量 / 总非对角线单元格 × 100%
```

### 测试覆盖率 (Test Coverage)
```
覆盖率 = 已测试点对数量 / 总点对数量 × 100%
```

### 继电器效率 (Relay Efficiency)
```
继电器效率 = 测试次数 / 继电器操作次数
```

## 配置选项

### 批量测试配置
```python
'batch_testing': {
    'enabled': True,                    # 启用批量测试
    'max_targets_per_source': 20,      # 每个电源点最大目标数
    'min_batch_size': 5,               # 最小批量大小
    'max_batch_size': 50               # 最大批量大小
}
```

### 二分法测试配置 ⭐ 新增
```python
'binary_search_config': {
    'enabled': True,                    # 启用二分法测试
    'batch_size': 20,                  # 二分法测试批次大小
    'probability_threshold': 0.5,       # 导通概率阈值
    'neighbor_weight': 0.7,            # 邻居关系权重
    'global_density_weight': 0.3,      # 全局密度权重
    'max_iterations_per_source': 5,    # 每个电源点最大迭代次数
    'adaptive_batch_sizing': True      # 自适应批次大小
}
```

### 50%智能批量测试配置 ⭐ 最新优化
```python
'optimized_50_percent_config': {
    'enabled': True,                    # 启用50%智能批量测试
    'target_coverage': 50.0,           # 目标覆盖率50%
    'max_batch_size': 50,              # 最大批量大小50
    'smart_deduplication': True,       # 智能去重
    'avoid_known_relations': True,     # 避免已知关系
    'max_targets_per_batch': 25,      # 每批最大目标数25
    'redundancy_analysis': True        # 冗余度分析
}
```

### 混合策略测试配置 ⭐ 最新智能策略
```python
'hybrid_strategy_config': {
    'enabled': True,                    # 启用混合策略测试
    'auto_phase_switch': True,         # 自动阶段切换
    'block_phase': {
        'target_coverage': 50.0,       # 分块策略目标覆盖率
        'max_batch_size': 50,          # 最大批量大小
        'smart_deduplication': True,   # 智能去重
        'avoid_known_relations': True  # 避免已知关系
    },
    'binary_phase': {
        'batch_size': 20,              # 二分法批次大小
        'probability_threshold': 0.5,  # 导通概率阈值
        'neighbor_weight': 0.7,        # 邻居关系权重
        'global_density_weight': 0.3   # 全局密度权重
    },
    'phase_switch': {
        'block_to_binary_threshold': 70.0,  # 分块到二分法切换阈值
        'min_phase_duration': 3,           # 最小阶段持续时间
        'adaptive_threshold': True         # 自适应阈值调整
    }
}
```

### 效率阈值配置
```python
'efficiency_thresholds': {
    'detection_rate_target': 90.0,     # 检测率目标
    'accuracy_rate_target': 95.0,      # 准确率目标
    'coverage_target': 85.0            # 覆盖率目标
}
```

### 继电器优化配置
```python
'relay_optimization': {
    'enabled': True,                    # 启用继电器优化
    'max_relay_operations': 1000,      # 最大操作次数
    'batch_mode': True,                # 批量模式
    'smart_switching': True            # 智能切换
}
```

## 最佳实践

### 1. 测试前准备
- 确保服务器正常运行
- 检查关系矩阵是否已初始化
- 验证导通分布设置是否正确

### 2. 参数调优
- 根据系统规模调整批量大小
- 根据继电器性能调整测试间隔
- 根据时间要求调整轮次数量

### 3. 监控和调整
- 实时监控检测率和准确率
- 观察继电器操作次数
- 根据性能指标动态调整策略

### 4. 错误处理
- 设置合理的重试次数
- 监控网络连接状态
- 记录测试失败的原因

## 故障排除

### 常见问题

1. **连接失败**
   - 检查服务器地址和端口
   - 验证网络连接
   - 检查防火墙设置

2. **测试超时**
   - 增加超时时间
   - 减少每轮测试数量
   - 检查服务器性能

3. **继电器操作过多**
   - 启用批量模式
   - 减少测试轮次
   - 优化测试策略

4. **检测率不提升**
   - 检查测试计划生成
   - 验证关系矩阵更新
   - 调整信息增益权重

### 调试模式

```python
# 启用调试模式
import logging
logging.basicConfig(level=logging.DEBUG)

# 运行测试
client.run_optimized_testing()
```

## 扩展和定制

### 自定义测试策略
```python
class CustomTestClient(OptimizedTestClient):
    def custom_test_strategy(self):
        # 实现自定义测试逻辑
        pass
```

### 自定义信息增益计算
```python
def custom_information_gain(self, power_source, target):
    # 实现自定义信息增益算法
    return custom_score
```

### 自定义批量分组
```python
def custom_batch_grouping(self, candidates):
    # 实现自定义分组逻辑
    return grouped_candidates
```

## 总结

优化测试客户端通过智能的测试规划和批量测试策略，显著提高了测试效率，减少了继电器操作次数。通过关系矩阵分析和信息增益计算，确保每次测试都能获得最大的信息价值。

建议根据具体的系统规模和性能要求，调整配置参数，找到最适合的测试策略。